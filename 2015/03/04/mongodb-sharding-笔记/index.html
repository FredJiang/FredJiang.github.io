<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title> </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="title: mongodb sharding 笔记date: 2015-03-04 17:57:35
tags: [mongo, sharding]笔记：MongoDB - The Definitive Guide
http://docs.mongodb.org/manual/sharding
When to Shard
You’ve run out of disk space on your">
<meta property="og:type" content="article">
<meta property="og:title" content=" ">
<meta property="og:url" content="http://fredjiang.github.io/2015/03/04/mongodb-sharding-笔记/index.html">
<meta property="og:site_name" content=" ">
<meta property="og:description" content="title: mongodb sharding 笔记date: 2015-03-04 17:57:35
tags: [mongo, sharding]笔记：MongoDB - The Definitive Guide
http://docs.mongodb.org/manual/sharding
When to Shard
You’ve run out of disk space on your">
<meta property="og:updated_time" content="2016-03-28T03:48:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" ">
<meta name="twitter:description" content="title: mongodb sharding 笔记date: 2015-03-04 17:57:35
tags: [mongo, sharding]笔记：MongoDB - The Definitive Guide
http://docs.mongodb.org/manual/sharding
When to Shard
You’ve run out of disk space on your">
  
    <link rel="alternate" href="/atom.xml" title=" " type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"> </a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle"> </a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fredjiang.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-mongodb-sharding-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/04/mongodb-sharding-笔记/" class="article-date">
  <time datetime="2015-03-04T09:57:35.000Z" itemprop="datePublished">2015-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>title: mongodb sharding 笔记<br>date: 2015-03-04 17:57:35</p>
<h2 id="tags-mongo-sharding"><a href="#tags-mongo-sharding" class="headerlink" title="tags: [mongo, sharding]"></a>tags: [mongo, sharding]</h2><p>笔记：MongoDB - The Definitive Guide</p>
<p><a href="http://docs.mongodb.org/manual/sharding" target="_blank" rel="external">http://docs.mongodb.org/manual/sharding</a></p>
<h3 id="When-to-Shard"><a href="#When-to-Shard" class="headerlink" title="When to Shard"></a>When to Shard</h3><ul>
<li>You’ve run out of disk space on your current machine.</li>
<li>You want to write data faster than a single mongod can handle.</li>
<li>Youwanttokeepalargerproportionofdatainmemorytoimproveperformance.</li>
</ul>
<a id="more"></a>
<h3 id="The-Key-to-Sharding-Shard-Keys"><a href="#The-Key-to-Sharding-Shard-Keys" class="headerlink" title="The Key to Sharding: Shard Keys"></a>The Key to Sharding: Shard Keys</h3><p>When you set up sharding, you choose a key from a collection and use that key’s values to split up the data. This key is called a shard key.</p>
<p>Let’s look at an example to see how this works: suppose we had a collection of documents representing people. If we chose “name” as our shard key, one shard could hold documents where the “name” started with A–F, the next shard could hold names from G–P, and the final shard would hold names from Q–Z. As you added (or removed) shards, MongoDB would rebalance this data so that each shard was getting a balanced amount of traffic and a sensible amount of data (e.g., if a shard is getting a lot of traffic, it might have less data than a shard with data that is less “hot”).</p>
<p>If we choose to shard on something like “timestamp”, where the value is probably going to increase and not jump around a lot, we’ll be sending all of the inserts to one shard (the one with the [June 27, 2003, ∞] chunk). Notice that, if we add a new shard and it splits the data again, we’ll still be inserting on just one server. If we add a new shard, MongoDB might split [June 27, 2003, ∞] into [June 27, 2003, December 12, 2010) and [December 12, 2010, ∞]. We’ll always have a chunk that will be “some date through infinity,” which is where our inserts will be going. This isn’t good for a very high write load, but it will make queries on the shard key very efficient.</p>
<h3 id="Setting-Up-Sharding"><a href="#Setting-Up-Sharding" class="headerlink" title="Setting Up Sharding"></a>Setting Up Sharding</h3><p>Sharding basically involves three different components working together:</p>
<h6 id="shard"><a href="#shard" class="headerlink" title="shard"></a>shard</h6><p>A shard is a container that holds a subset of a collection’s data. A shard is either a single mongod server (for development/testing) or a replica set (for production). Thus, even if there are many servers in a shard, there is only one master, and all of the servers contain the same data.</p>
<h6 id="mongos"><a href="#mongos" class="headerlink" title="mongos"></a>mongos</h6><p>This is the router process and comes with all MongoDB distributions. It basically just routes requests and aggregates responses. It doesn’t store any data or configuration information. (Although it does cache information from the config servers.)</p>
<p>######config server<br>Config servers store the configuration of the cluster: which data is on which shard. Because mongos doesn’t store anything permanently, it needs somewhere to get the shard configuration. It syncs this data from the config servers.</p>
<p>If you are working with MongoDB already, you probably have a shard ready to go. (Your current mongod can become your first shard.) The following section shows how to create a new shard from scratch, but feel free to use your existing database instead.</p>
<h3 id="Starting-the-Servers"><a href="#Starting-the-Servers" class="headerlink" title="Starting the Servers"></a>Starting the Servers</h3><p>First we need to start up our config server and mongos. The config server needs to be started first, because mongos uses it to get its configuration. The config server can be started like any other mongod process:</p>
<pre><code>mkdir -p ~/dbs/config
mongod --dbpath ~/dbs/config --port 20000
</code></pre><p>Now you need a mongos process for your application to connect to. Routing servers don’t even need a data directory, but they need to know where the config server is:</p>
<pre><code>mongos --port 30000 --configdb localhost:20000
</code></pre><h6 id="Adding-a-shard"><a href="#Adding-a-shard" class="headerlink" title="Adding a shard"></a>Adding a shard</h6><p>A shard is just a normal mongod instance (or replica set):</p>
<pre><code>mkdir -p ~/dbs/shard1
mongod --dbpath ~/dbs/shard1 --port 10000
</code></pre><p>Now we’ll connect to the mongos process we started and add the shard to the cluster.<br>Start up a shell connected to your mongos:</p>
<pre><code>mongo localhost:30000/admin
</code></pre><p>Make sure you’re connected to mongos, not a mongod. Now you can add this shard with<br>the addshard database command:</p>
<pre><code>db.runCommand({addshard : &quot;localhost:10000&quot;, allowLocal : true})
</code></pre><h3 id="Sharding-Data"><a href="#Sharding-Data" class="headerlink" title="Sharding Data"></a>Sharding Data</h3><p>Let’s look at an example: we’ll shard the bar collection in the foo database on the “_id” key. First, we enable sharding for foo:</p>
<pre><code>db.runCommand({&quot;enablesharding&quot; : &quot;foo&quot;})
db.runCommand({&quot;shardcollection&quot; : &quot;foo.bar&quot;, &quot;key&quot; : {&quot;_id&quot; : 1}})
</code></pre><h3 id="Production-Configuration"><a href="#Production-Configuration" class="headerlink" title="Production Configuration"></a>Production Configuration</h3><p>The example in the previous section is fine for trying sharding or for development. However, when you move an application into production, you’ll want a more robust setup. To set up sharding with no points of failure, you’ll need the following:</p>
<ul>
<li>Multiple config servers • Multiplemongosservers</li>
<li>Replica sets for each shard</li>
<li>w set correctly (see the previous chapter for information on w and replication)</li>
</ul>
<h6 id="A-Robust-Config"><a href="#A-Robust-Config" class="headerlink" title="A Robust Config"></a>A Robust Config</h6><p>Setting up multiple config servers is simple. As of this writing, you can have one config server (for development) or three config servers (for production).</p>
<p>Setting up multiple config servers is the same as setting up one; you just do it three times:</p>
<pre><code>mkdir -p ~/dbs/config1 ~/dbs/config2 ~/dbs/config3
mongod --dbpath ~/dbs/config1 --port 20001
mongod --dbpath ~/dbs/config2 --port 20002
mongod --dbpath ~/dbs/config3 --port 20003
</code></pre><p>Then, when you start a mongos, you should connect it to all three config servers:</p>
<pre><code>mongos --configdb localhost:20001,localhost:20002,localhost:20003
</code></pre><p>Config servers use two-phase commit, not the normal MongoDB asynchronous repli- cation, to maintain separate copies of the cluster’s configuration. This ensures that they always have a consistent view of the cluster’s state. It also means that if a single config server is down, the cluster’s configuration information will go read-only. Clients are still able to do both reads and writes, but no rebalancing will happen until all of the config servers are back up.</p>
<h6 id="Many-mongos"><a href="#Many-mongos" class="headerlink" title="Many mongos"></a>Many mongos</h6><p>You can also run as many mongos processes as you want. One recommended setup is to run a mongos process for every application server. That way, each application server can talk to mongos locally, and if the server goes down, no one will be trying to talk to a mongos that isn’t there.</p>
<h6 id="A-Sturdy-Shard"><a href="#A-Sturdy-Shard" class="headerlink" title="A Sturdy Shard"></a>A Sturdy Shard</h6><p>In production, each shard should be a replica set. That way, an individual server can fail without bringing down the whole shard. To add a replica set as a shard, pass its name and a seed to the addshard command.<br>For example, say we have a replica set named “foo” containing a server at prod.example.com:27017 (among other servers). We could add this set to the cluster with the following:</p>
<pre><code>db.runCommand({&quot;addshard&quot; : &quot;foo/prod.example.com:27017&quot;})
</code></pre><p>If prod.example.com goes down, mongos will know that it is connected to a replica set<br>and use the new primary for that set.</p>
<h6 id="Physical-Servers"><a href="#Physical-Servers" class="headerlink" title="Physical Servers"></a>Physical Servers</h6><p>This may seem like an overwhelming number of machines: three config servers, at least two mongods per shard, and as many mongos processes as you want. However, not ev- erything has to have its own machine. The main thing to avoid is putting an entire component on one machine. For example, avoid putting all three config servers, all of your mongos processes, or an entire replica set on one machine. However, a config server and mongos processes can happily share a box with a member of a replica set.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/04/mongodb-sharding-笔记/" data-id="cim2q4lav0007k1rsfic7n4lh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/03/10/nginx-日志分析/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          nginx 日志分析
        
      </div>
    </a>
  
  
    <a href="/2015/02/28/mongo-Replica-Set-笔记/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">mongo Replica Set 笔记</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot/">boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/command/">command</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/event/">event</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goaccess/">goaccess</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iWatch/">iWatch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/">json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log/">log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logrotate/">logrotate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/master/">master</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memerory/">memerory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongo/">mongo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/">note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pm2/">pm2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pm2-web/">pm2-web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/replication/">replication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/">server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/slave/">slave</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/startup/">startup</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/boot/" style="font-size: 10px;">boot</a> <a href="/tags/command/" style="font-size: 10px;">command</a> <a href="/tags/event/" style="font-size: 10px;">event</a> <a href="/tags/goaccess/" style="font-size: 10px;">goaccess</a> <a href="/tags/iWatch/" style="font-size: 10px;">iWatch</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/log/" style="font-size: 20px;">log</a> <a href="/tags/logrotate/" style="font-size: 10px;">logrotate</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/master/" style="font-size: 10px;">master</a> <a href="/tags/memerory/" style="font-size: 10px;">memerory</a> <a href="/tags/mongo/" style="font-size: 20px;">mongo</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/note/" style="font-size: 10px;">note</a> <a href="/tags/pm2/" style="font-size: 10px;">pm2</a> <a href="/tags/pm2-web/" style="font-size: 10px;">pm2-web</a> <a href="/tags/replication/" style="font-size: 10px;">replication</a> <a href="/tags/server/" style="font-size: 20px;">server</a> <a href="/tags/slave/" style="font-size: 10px;">slave</a> <a href="/tags/startup/" style="font-size: 10px;">startup</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/03/18/node-内存优化笔记（一）/">node 内存优化笔记（一）</a>
          </li>
        
          <li>
            <a href="/2016/03/14/linux-启动过程/">linux 启动过程</a>
          </li>
        
          <li>
            <a href="/2016/03/11/node-事件驱动机制/">node 事件驱动机制</a>
          </li>
        
          <li>
            <a href="/2015/03/18/iWatch-使用/">iWatch 使用</a>
          </li>
        
          <li>
            <a href="/2015/03/12/markdown-生成目录/">markdown 生成目录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Fred Jiang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3b7bc98f0d58e8d3df6d85dca6f10565";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>