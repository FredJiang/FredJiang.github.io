<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title> </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content=" ">
<meta property="og:url" content="http://fredjiang.github.io/index.html">
<meta property="og:site_name" content=" ">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" ">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title=" " type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"> </a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle"> </a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fredjiang.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-node-内存优化笔记-一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/18/node-内存优化笔记-一/" class="article-date">
  <time datetime="2016-03-18T05:48:15.000Z" itemprop="datePublished">2016-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/18/node-内存优化笔记-一/">node 内存优化笔记(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://www.amazon.cn/Deploying-Node-js-Pasquali-Sandro/dp/1783981407/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1458280419&amp;sr=1-1&amp;keywords=9781783981403">Deploying Node.js</a></p>
<p>The design and implementation of Node.js native modules follow a simple directive: keep everything asynchronous. This design ethic, by convention, informs the design of modules contributed by the Node community.</p>
        
          <p class="article-more-link">
            <a href="/2016/03/18/node-内存优化笔记-一/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2016/03/18/node-内存优化笔记-一/" data-id="cilxamgf0000albrsk3ku8dnk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memerory/">memerory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-启动过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/14/linux-启动过程/" class="article-date">
  <time datetime="2016-03-14T10:36:49.000Z" itemprop="datePublished">2016-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/14/linux-启动过程/">linux 启动过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>按下电源按钮 出现登陆提示</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2016/03/14/linux-启动过程/" data-id="cilxamgeg0003lbrsen3p4qi8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/boot/">boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/startup/">startup</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-node-事件驱动机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/11/node-事件驱动机制/" class="article-date">
  <time datetime="2016-03-11T14:58:12.000Z" itemprop="datePublished">2016-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/11/node-事件驱动机制/">node 事件驱动机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以下面代码执行为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);</span><br><span class="line">fs.readFile(&apos;foo.js&apos;, &#123;encoding:&apos;utf8&apos;&#125;, function(err,</span><br><span class="line">  fileContents) &#123;</span><br><span class="line">  console.log(&apos;Then the contents are available&apos;, fileContents);</span><br><span class="line">&#125;);</span><br><span class="line">console.log(&apos;This happens first&apos;);</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">This happens first</span><br><span class="line">Then the contents are available, [file contents shown]</span><br></pre></td></tr></table></figure>
<p>执行逻辑</p>
<ul>
<li>加载 fs 模块。获取到 fs.binding，fs.binding 用来连接 C++ 和 JS 代码</li>
<li>调用 fs.readFile。通过 fs.binding，<a href="http://nikhilm.github.io/uvbook/basics.html" target="_blank" rel="external">libuv</a> 接收到一个读文件的请求和一个回调函数</li>
<li>libuv 在自己的线程里调用系统级别的相关方法来读取文件</li>
<li>JavaScript 程序继续执行，打印出 “This happens first”</li>
<li>因为还有一个 callback，event loop 继续执行</li>
<li>当 OS 读完文件描述符后，libuv 得到通知并且调用回调函数，为 JavaScript 的 callback 重新进入 V8 线程做准备</li>
<li>JavaScript 的 callback 被放到 event loop 队列里面并在下一个 tick 中执行</li>
<li>打印 “Then the contents are available “</li>
<li>没有 callback 了，进程结束</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2016/03/11/node-事件驱动机制/" data-id="cilxamgf3000blbrsrt8j6obg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/event/">event</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-iWatch-使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/18/iWatch-使用/" class="article-date">
  <time datetime="2015-03-18T12:50:27.000Z" itemprop="datePublished">2015-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/18/iWatch-使用/">iWatch 使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装-iwatch"><a href="#安装-iwatch" class="headerlink" title="安装 iwatch"></a>安装 iwatch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install iwatch</span><br></pre></td></tr></table></figure>
<p>postfix 的配置选择</p>
<blockquote>
<p>Internet Site</p>
</blockquote>
<h3 id="配置-iwatch"><a href="#配置-iwatch" class="headerlink" title="配置 iwatch"></a>配置 iwatch</h3><p>配置文件为 /etc/iwatch/iwatch.xml</p>
<p>内容为</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; ?&gt;
&lt;!DOCTYPE config SYSTEM &quot;/etc/iwatch/iwatch.dtd&quot; &gt;
&lt;config&gt;
  &lt;guard email=&quot;root@localhost&quot; name=&quot;IWatch&quot;/&gt;
  &lt;watchlist&gt;
    &lt;title&gt;报错了&lt;/title&gt;
    &lt;contactpoint email=&quot;email1;email2&quot; name=&quot;&quot;/&gt;
    &lt;path type=&quot;single&quot; syslog=&quot;on&quot; events=&quot;modify&quot; filter=&quot;([\s\S]*)error([\s\S]*)log&quot;&gt;/root/.pm2/logs&lt;/path&gt;
  &lt;/watchlist&gt;
&lt;/config&gt;
</code></pre><p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE config SYSTEM &quot;/etc/iwatch/iwatch.dtd&quot; &gt;</span><br><span class="line">&lt;config&gt;</span><br><span class="line">  &lt;guard email=&quot;root@localhost&quot; name=&quot;IWatch&quot;/&gt;</span><br><span class="line">  &lt;watchlist&gt;</span><br><span class="line">    &lt;title&gt;报错了&lt;/title&gt;</span><br><span class="line">    &lt;contactpoint email=&quot;&quot; name=&quot;&quot;/&gt;</span><br><span class="line">    &lt;path type=&quot;single&quot; syslog=&quot;on&quot; events=&quot;modify&quot; filter=&quot;([\s\S]*)error([\s\S]*)(log$)&quot; exec=&quot;if [ `cat %f | wc -l` -ne 0 ]; then cat %f | mail -s `hostname`&apos; %f is accessed&apos; &apos;email1,email2&apos;; else echo no content to email; fi;&quot;&gt;/root/.pm2/logs&lt;/path&gt;</span><br><span class="line">  &lt;/watchlist&gt;</span><br><span class="line">&lt;/config&gt;</span><br></pre></td></tr></table></figure>
<h3 id="运行-iwatch"><a href="#运行-iwatch" class="headerlink" title="运行 iwatch"></a>运行 iwatch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iwatch -f /etc/iwatch/iwatch.xml -v</span><br></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>创建文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /root/.pm2/logs/testerror.log</span><br></pre></td></tr></table></figure>
<p>如果正常的话，就能收到邮件了</p>
<p>如果报错或者没收到邮件的话，可以查看 /var/log/mail.log 文件</p>
<p>我遇到了</p>
<blockquote>
<p>Jul  4 23:04:37 ubuntu postfix/smtpd[15269]: disconnect from unknown[192.168.1.150]</p>
</blockquote>
<p>解决办法</p>
<p>在 /etc/postfix/main.cf 中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128</span><br></pre></td></tr></table></figure>
<p>后面添加 192.168.1.150</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.1.150</span><br></pre></td></tr></table></figure>
<h3 id="设置守护进程"><a href="#设置守护进程" class="headerlink" title="设置守护进程"></a>设置守护进程</h3><p>将 /etc/default/iwatch 中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START_DAEMON=false</span><br></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START_DAEMON=true</span><br></pre></td></tr></table></figure>
<h3 id="启动守护进程"><a href="#启动守护进程" class="headerlink" title="启动守护进程"></a>启动守护进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/iwatch restart</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/18/iWatch-使用/" data-id="cilxamge70001lbrskokqmw26" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iWatch/">iWatch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log/">log</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-markdown-生成目录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/12/markdown-生成目录/" class="article-date">
  <time datetime="2015-03-12T13:37:39.000Z" itemprop="datePublished">2015-03-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/12/markdown-生成目录/">markdown 生成目录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>用 markdown 写完接口文档后，想根据接口文档自动生成一个目录</p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>markdown 代码</p>
<pre><code>[接口1](#interface1)
### [/接口1](id:interface1)
</code></pre><p>装换成对应的 html 代码</p>
<pre><code>&lt;a href=&quot;#interface1&quot;&gt;接口1&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;&lt;span id=&quot;interface1&quot;&gt;/接口1&lt;/span&gt;&lt;/h3&gt;
</code></pre><p>在写 markdown 的时候，</p>
<p>我只想写（修改接口文档时太麻烦了）</p>
<pre><code>### [/接口1](id:interface1)
</code></pre><p>不想写</p>
<pre><code>[接口1](#interface1)
</code></pre><p>所以这里需要做的是</p>
<p>读取原 markdown 文件，根据</p>
<pre><code>### [/接口1](id:interface1)
</code></pre><p>得到</p>
<pre><code>[接口1](#interface1)
</code></pre><p>装换用的 python 代码</p>
<pre><code>#!/usr/bin/python
#coding:utf-8

import sys
import re

markdownFileName = sys.argv[1]

for line in open(markdownFileName):
    match = re.search(r&quot;\[([\s\S]*)\]\(id:([\s\S]*)\)&quot;, line)
    if match:
        print(re.sub(&quot;id:&quot;, &quot;#&quot;, match.group(0)))
        print(&quot;&quot;)
</code></pre><p>使用方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python produceMDCategory.py test.md</span><br></pre></td></tr></table></figure>
<p>输出</p>
<pre><code>[/接口1](#interface1)
</code></pre><p>现在只要把输出的内容，拷贝到 test.md 中即可</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/12/markdown-生成目录/" data-id="cilxamget0008lbrsq6hru1h3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/markdown/">markdown</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx-日志分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/10/nginx-日志分析/" class="article-date">
  <time datetime="2015-03-10T07:27:39.000Z" itemprop="datePublished">2015-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/10/nginx-日志分析/">nginx 日志分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装-goaccess"><a href="#安装-goaccess" class="headerlink" title="安装 goaccess"></a>安装 goaccess</h3><p>我的机器为 ubuntu，用 sudo apt-get install goaccess 安装后，使用时报错 Unknown option `–’.</p>
<p>命令</p>
<p>goaccess –version</p>
<p>依然报错 Unknown option `–’.</p>
<p>后参考官网编译安装成功 <a href="http://goaccess.io/download" target="_blank" rel="external">http://goaccess.io/download</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://tar.goaccess.io/goaccess-0.8.5.tar.gz</span><br><span class="line">$ tar -xzvf goaccess-0.8.5.tar.gz</span><br><span class="line">$ cd goaccess-0.8.5/</span><br><span class="line">$ sudo apt-get install libncursesw5-dev libglib2.0-dev libgeoip-dev</span><br><span class="line">$ ./configure --enable-geoip --enable-utf8</span><br><span class="line">$ make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>
<h3 id="修改-nginx-日志的归档文件名格式"><a href="#修改-nginx-日志的归档文件名格式" class="headerlink" title="修改 nginx 日志的归档文件名格式"></a>修改 nginx 日志的归档文件名格式</h3><p>配置文件为：/etc/logrotate.d/nginx</p>
<p>文件内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/var/log/nginx/*.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    missingok</span><br><span class="line">    rotate 52</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    notifempty</span><br><span class="line">    create 0644 www-data adm </span><br><span class="line">    dateext</span><br><span class="line">    dateformat -%Y%m%d</span><br><span class="line">    sharedscripts</span><br><span class="line">    prerotate</span><br><span class="line">        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \</span><br><span class="line">            run-parts /etc/logrotate.d/httpd-prerotate; \</span><br><span class="line">        fi; \</span><br><span class="line">    endscript</span><br><span class="line">    postrotate</span><br><span class="line">        [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加内容</p>
<blockquote>
<p>dateext</p>
<p>dateformat -%Y%m%d</p>
</blockquote>
<h3 id="修改-nginx-log-format"><a href="#修改-nginx-log-format" class="headerlink" title="修改 nginx log format"></a>修改 nginx log format</h3><p>配置文件为：/etc/nginx/nginx.conf</p>
<p>添加内容：</p>
<pre><code>    ##
    # Logging Settings
    ##
    log_format compression &apos;$remote_addr - $remote_user [$time_local] &apos;
                           &apos;&quot;$request&quot; $status $bytes_sent &apos;
                           &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$gzip_ratio &quot;$request_time&quot;&apos;;
    access_log /var/log/nginx/access.log compression;

#    access_log /var/log/nginx/access.log;
</code></pre><h3 id="重启-nginx"><a href="#重启-nginx" class="headerlink" title="重启 nginx"></a>重启 nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure>
<h3 id="python-脚本"><a href="#python-脚本" class="headerlink" title="python 脚本"></a>python 脚本</h3><p>新建文件 sendMail.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch sendMail.py</span><br><span class="line">chmod +x sendMail.py</span><br></pre></td></tr></table></figure>
<p>sendMail.py 文件内容</p>
<pre><code>#!/usr/bin/python
#coding:utf-8
import sys
import time
import datetime
import os
import subprocess
import smtplib
from email.mime.text import MIMEText

############################################################
# 配置
mailProxy = &quot;smtp.gmail.com&quot;
mailProxyPort = 587

mailAccountUsername = &apos;&apos;
mailAccountUserPassword = &apos;&apos;

mailSubject = &quot;&quot;
mailFrom = &apos;&apos;
mailTo = &apos;mail1;mail2&apos;
############################################################


def generateReport():
    print(&quot;generateReport&quot;)
    print(datetime.datetime.now())

    global hasSend

    delta = datetime.timedelta(1)
    yesterday = datetime.date.today() - delta
    accessLogFileGZ = r&apos;/var/log/nginx/access.log-&apos; + yesterday.strftime(&apos;%Y%m%d&apos;) + &apos;.gz&apos;
    reportSaveFileHtml = r&apos;&apos; + os.getcwd() + &quot;/&quot; + yesterday.strftime(&apos;%Y%m%d&apos;) + &apos;.html&apos;

    print(&quot;accessLogFileGZ &quot; + accessLogFileGZ)
    print(&quot;reportSaveFileHtml &quot; + reportSaveFileHtml)

    if os.path.isfile(accessLogFileGZ) and (not os.path.isfile(reportSaveFileHtml)):
        cmd = r&apos;zcat -f &apos; + accessLogFileGZ + r&apos; | goaccess --date-format=&quot;%d/%b/%Y&quot; --log-format=&quot;%h - %^ [%d:%^] \&quot;%r\&quot; %s %b \&quot;%R\&quot; \&quot;%u\&quot; \&quot;%^ \&quot;%T\&quot;&quot; &gt; &apos; + reportSaveFileHtml
        print(&quot;cmd &quot; + cmd)
        subprocess.call(cmd, shell=True)
        hasSend = False
    else:
        print(&quot;os.path.isfile(accessLogFileGZ) and (not os.path.isfile(reportSaveFileHtml) false&quot;)
        hasSend = True

def sendMail():
    print(&quot;sendMail&quot;)
    print(datetime.datetime.now())

    global hasSend

    delta = datetime.timedelta(1)
    yesterday = datetime.date.today() - delta
    reportSaveFileHtml = r&apos;&apos; + os.getcwd() + &quot;/&quot; + yesterday.strftime(&apos;%Y%m%d&apos;) + &apos;.html&apos;

    print(&quot;reportSaveFileHtml &quot; + reportSaveFileHtml)

    if os.path.isfile(reportSaveFileHtml):
        f = open(reportSaveFileHtml)
        content = f.read()
        f.close()

        msg = MIMEText(content, &apos;html&apos;, &apos;utf-8&apos;)
        msg[&apos;Subject&apos;] = mailSubject + &quot;(&quot; + yesterday.strftime(&apos;%Y%m%d&apos;) + &quot;)&quot;
        msg[&apos;From&apos;] =  mailFrom
        msg[&apos;To&apos;] = mailTo

        try:
            s = smtplib.SMTP()
            s.connect(mailProxy, mailProxyPort)
            s.ehlo()
            s.starttls()
            s.login(mailAccountUsername, mailAccountUserPassword)
            s.sendmail(mailFrom, mailTo.split(&apos;;&apos;), msg.as_string())
            s.close()
            hasSend = True
        except Exception, e:
            hasSend = False
            print str(e)

hasSend = False
interval = 10 * 60

while True:
    generateReport()

    if not hasSend:
        print(&quot;&quot;)
        sendMail()

    print(&quot;&quot;)
    print(&quot;hasSend&quot;, hasSend)
    sys.stdout.flush()
    time.sleep(interval)
</code></pre><h3 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h3><p>python定时生成报告及发邮件，使用 nohup 放入后台运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python sendmail.py &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python sendmail.py &amp;</span><br></pre></td></tr></table></figure>
<h3 id="获取机器名字"><a href="#获取机器名字" class="headerlink" title="获取机器名字"></a>获取机器名字</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import platform</span><br><span class="line">hostname = platform.node()</span><br><span class="line">print(hostname)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/10/nginx-日志分析/" data-id="cilxamgf7000dlbrs4ojfon33" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/goaccess/">goaccess</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log/">log</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mongodb-sharding-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/04/mongodb-sharding-笔记/" class="article-date">
  <time datetime="2015-03-04T09:57:35.000Z" itemprop="datePublished">2015-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/04/mongodb-sharding-笔记/">mongodb sharding 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>笔记：MongoDB - The Definitive Guide</p>
<p><a href="http://docs.mongodb.org/manual/sharding" target="_blank" rel="external">http://docs.mongodb.org/manual/sharding</a></p>
<h3 id="When-to-Shard"><a href="#When-to-Shard" class="headerlink" title="When to Shard"></a>When to Shard</h3><ul>
<li>You’ve run out of disk space on your current machine.</li>
<li>You want to write data faster than a single mongod can handle.</li>
<li>Youwanttokeepalargerproportionofdatainmemorytoimproveperformance.</li>
</ul>
<h3 id="The-Key-to-Sharding-Shard-Keys"><a href="#The-Key-to-Sharding-Shard-Keys" class="headerlink" title="The Key to Sharding: Shard Keys"></a>The Key to Sharding: Shard Keys</h3><p>When you set up sharding, you choose a key from a collection and use that key’s values to split up the data. This key is called a shard key.</p>
<p>Let’s look at an example to see how this works: suppose we had a collection of documents representing people. If we chose “name” as our shard key, one shard could hold documents where the “name” started with A–F, the next shard could hold names from G–P, and the final shard would hold names from Q–Z. As you added (or removed) shards, MongoDB would rebalance this data so that each shard was getting a balanced amount of traffic and a sensible amount of data (e.g., if a shard is getting a lot of traffic, it might have less data than a shard with data that is less “hot”).</p>
<p>If we choose to shard on something like “timestamp”, where the value is probably going to increase and not jump around a lot, we’ll be sending all of the inserts to one shard (the one with the [June 27, 2003, ∞] chunk). Notice that, if we add a new shard and it splits the data again, we’ll still be inserting on just one server. If we add a new shard, MongoDB might split [June 27, 2003, ∞] into [June 27, 2003, December 12, 2010) and [December 12, 2010, ∞]. We’ll always have a chunk that will be “some date through infinity,” which is where our inserts will be going. This isn’t good for a very high write load, but it will make queries on the shard key very efficient.</p>
<h3 id="Setting-Up-Sharding"><a href="#Setting-Up-Sharding" class="headerlink" title="Setting Up Sharding"></a>Setting Up Sharding</h3><p>Sharding basically involves three different components working together:</p>
<h6 id="shard"><a href="#shard" class="headerlink" title="shard"></a>shard</h6><p>A shard is a container that holds a subset of a collection’s data. A shard is either a single mongod server (for development/testing) or a replica set (for production). Thus, even if there are many servers in a shard, there is only one master, and all of the servers contain the same data.</p>
<h6 id="mongos"><a href="#mongos" class="headerlink" title="mongos"></a>mongos</h6><p>This is the router process and comes with all MongoDB distributions. It basically just routes requests and aggregates responses. It doesn’t store any data or configuration information. (Although it does cache information from the config servers.)</p>
<p>######config server<br>Config servers store the configuration of the cluster: which data is on which shard. Because mongos doesn’t store anything permanently, it needs somewhere to get the shard configuration. It syncs this data from the config servers.</p>
<p>If you are working with MongoDB already, you probably have a shard ready to go. (Your current mongod can become your first shard.) The following section shows how to create a new shard from scratch, but feel free to use your existing database instead.</p>
<h3 id="Starting-the-Servers"><a href="#Starting-the-Servers" class="headerlink" title="Starting the Servers"></a>Starting the Servers</h3><p>First we need to start up our config server and mongos. The config server needs to be started first, because mongos uses it to get its configuration. The config server can be started like any other mongod process:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/dbs/config</span><br><span class="line">mongod --dbpath ~/dbs/config --port 20000</span><br></pre></td></tr></table></figure>
<p>Now you need a mongos process for your application to connect to. Routing servers don’t even need a data directory, but they need to know where the config server is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos --port 30000 --configdb localhost:20000</span><br></pre></td></tr></table></figure>
<h6 id="Adding-a-shard"><a href="#Adding-a-shard" class="headerlink" title="Adding a shard"></a>Adding a shard</h6><p>A shard is just a normal mongod instance (or replica set):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/dbs/shard1</span><br><span class="line">mongod --dbpath ~/dbs/shard1 --port 10000</span><br></pre></td></tr></table></figure>
<p>Now we’ll connect to the mongos process we started and add the shard to the cluster.<br>Start up a shell connected to your mongos:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo localhost:30000/admin</span><br></pre></td></tr></table></figure>
<p>Make sure you’re connected to mongos, not a mongod. Now you can add this shard with<br>the addshard database command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;addshard : &quot;localhost:10000&quot;, allowLocal : true&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Sharding-Data"><a href="#Sharding-Data" class="headerlink" title="Sharding Data"></a>Sharding Data</h3><p>Let’s look at an example: we’ll shard the bar collection in the foo database on the “_id” key. First, we enable sharding for foo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;&quot;enablesharding&quot; : &quot;foo&quot;&#125;)</span><br><span class="line">db.runCommand(&#123;&quot;shardcollection&quot; : &quot;foo.bar&quot;, &quot;key&quot; : &#123;&quot;_id&quot; : 1&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Production-Configuration"><a href="#Production-Configuration" class="headerlink" title="Production Configuration"></a>Production Configuration</h3><p>The example in the previous section is fine for trying sharding or for development. However, when you move an application into production, you’ll want a more robust setup. To set up sharding with no points of failure, you’ll need the following:</p>
<ul>
<li>Multiple config servers • Multiplemongosservers</li>
<li>Replica sets for each shard</li>
<li>w set correctly (see the previous chapter for information on w and replication)</li>
</ul>
<h6 id="A-Robust-Config"><a href="#A-Robust-Config" class="headerlink" title="A Robust Config"></a>A Robust Config</h6><p>Setting up multiple config servers is simple. As of this writing, you can have one config server (for development) or three config servers (for production).</p>
<p>Setting up multiple config servers is the same as setting up one; you just do it three times:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/dbs/config1 ~/dbs/config2 ~/dbs/config3mongod --dbpath ~/dbs/config1 --port 20001mongod --dbpath ~/dbs/config2 --port 20002mongod --dbpath ~/dbs/config3 --port 20003</span><br></pre></td></tr></table></figure>
<p>Then, when you start a mongos, you should connect it to all three config servers:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos --configdb localhost:20001,localhost:20002,localhost:20003</span><br></pre></td></tr></table></figure>
<p>Config servers use two-phase commit, not the normal MongoDB asynchronous repli- cation, to maintain separate copies of the cluster’s configuration. This ensures that they always have a consistent view of the cluster’s state. It also means that if a single config server is down, the cluster’s configuration information will go read-only. Clients are still able to do both reads and writes, but no rebalancing will happen until all of the config servers are back up.</p>
<h6 id="Many-mongos"><a href="#Many-mongos" class="headerlink" title="Many mongos"></a>Many mongos</h6><p>You can also run as many mongos processes as you want. One recommended setup is to run a mongos process for every application server. That way, each application server can talk to mongos locally, and if the server goes down, no one will be trying to talk to a mongos that isn’t there.</p>
<h6 id="A-Sturdy-Shard"><a href="#A-Sturdy-Shard" class="headerlink" title="A Sturdy Shard"></a>A Sturdy Shard</h6><p>In production, each shard should be a replica set. That way, an individual server can fail without bringing down the whole shard. To add a replica set as a shard, pass its name and a seed to the addshard command.<br>For example, say we have a replica set named “foo” containing a server at prod.example.com:27017 (among other servers). We could add this set to the cluster with the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;&quot;addshard&quot; : &quot;foo/prod.example.com:27017&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>If prod.example.com goes down, mongos will know that it is connected to a replica set<br>and use the new primary for that set.</p>
<h6 id="Physical-Servers"><a href="#Physical-Servers" class="headerlink" title="Physical Servers"></a>Physical Servers</h6><p>This may seem like an overwhelming number of machines: three config servers, at least two mongods per shard, and as many mongos processes as you want. However, not ev- erything has to have its own machine. The main thing to avoid is putting an entire component on one machine. For example, avoid putting all three config servers, all of your mongos processes, or an entire replica set on one machine. However, a config server and mongos processes can happily share a box with a member of a replica set.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/04/mongodb-sharding-笔记/" data-id="cilxamgfm000ilbrse8h4cxgw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sharding/">sharding</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mongo-Replica-Set-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/28/mongo-Replica-Set-笔记/" class="article-date">
  <time datetime="2015-02-28T06:53:10.000Z" itemprop="datePublished">2015-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/28/mongo-Replica-Set-笔记/">mongo Replica Set 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>笔记：MongoDB - The Definitive Guide</p>
<h6 id="Replica-Sets"><a href="#Replica-Sets" class="headerlink" title="Replica Sets"></a>Replica Sets</h6><blockquote>
<p>A replica set is basically a master-slave cluster with automatic failover. The biggest difference between a master-slave cluster and a replica set is that a replica set does not have a single master: one is elected by the cluster and may change to another node if the current master goes down. However, they look very similar: a replica set always has a single master node (called a primary) and one or more slaves (called secondaries). </p>
</blockquote>
<h6 id="创建数据库目录"><a href="#创建数据库目录" class="headerlink" title="创建数据库目录"></a>创建数据库目录</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /Users/Fred/Desktop/mongoSetTest/dbs/node1</span><br><span class="line">mkdir -p /Users/Fred/Desktop/mongoSetTest/dbs/node2</span><br><span class="line">mkdir -p /Users/Fred/Desktop/mongoSetTest/dbs/node3</span><br></pre></td></tr></table></figure>
<h6 id="运行-mongod"><a href="#运行-mongod" class="headerlink" title="运行 mongod"></a>运行 mongod</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /Users/Fred/Desktop/mongoSetTest/dbs/node1 --port 10001 --replSet blort/Fred:10002</span><br><span class="line">mongod --dbpath /Users/Fred/Desktop/mongoSetTest/dbs/node2 --port 10002 --replSet blort/Fred:10001</span><br><span class="line">mongod --dbpath /Users/Fred/Desktop/mongoSetTest/dbs/node3 --port 10003 --replSet blort/Fred:10001</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Once you have a few servers up, you’ll notice that the server logs are complaining about the replica set not being initialized. This is because there’s one more step: initializing the set in the shell</p>
</blockquote>
<h6 id="初始化-replica-set"><a href="#初始化-replica-set" class="headerlink" title="初始化 replica set"></a>初始化 replica set</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mongo 127.0.0.1:10001</span><br><span class="line"></span><br><span class="line">use admin</span><br><span class="line"></span><br><span class="line">db.runCommand(&#123;</span><br><span class="line">    &quot;replSetInitiate&quot;: &#123;</span><br><span class="line">        &quot;_id&quot;: &quot;blort&quot;,</span><br><span class="line">        &quot;members&quot;: [&#123;</span><br><span class="line">            &quot;_id&quot;: 1,</span><br><span class="line">            &quot;host&quot;: &quot;10.8.6.229:10001&quot;</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            &quot;_id&quot;: 2,</span><br><span class="line">            &quot;host&quot;: &quot;10.8.6.229:10002&quot;</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            &quot;_id&quot;: 3,</span><br><span class="line">            &quot;host&quot;: &quot;10.8.6.229:10003&quot;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>再分别连接 mongo 的 shell，node1 为 PRIMARY，其他为 SECONDARY</p>
<p>node1</p>
<blockquote>
<p>Fred:dbs Fred$ mongo 127.0.0.1:10001</p>
<p>MongoDB shell version: 2.6.5</p>
<p>connecting to: 127.0.0.1:10001/test</p>
<p>blort:PRIMARY</p>
</blockquote>
<p>node2</p>
<blockquote>
<p>Fred:dbs Fred$ mongo 127.0.0.1:10002</p>
<p>MongoDB shell version: 2.6.5</p>
<p>connecting to: 127.0.0.1:10002/test</p>
<p>blort:SECONDARY&gt;</p>
</blockquote>
<p>node3</p>
<blockquote>
<p>Fred:dbs Fred$ mongo 127.0.0.1:10003</p>
<p>MongoDB shell version: 2.6.5</p>
<p>connecting to: 127.0.0.1:10003/test</p>
<p>blort:SECONDARY&gt;</p>
</blockquote>
<p>停掉 node1，过一会再启动，node1 由 PRIMARY 变为 SECONDARY</p>
<blockquote>
<p>If the current primary fails, the rest of the nodes in the set will attempt to elect a new primary node. This election process will be initiated by any node that cannot reach the primary.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /Users/Fred/Desktop/mongoSetTest/dbs/node1 --port 10001 --replSet blort/Fred:10002</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Fred:dbs Fred$ mongo 127.0.0.1:10001</p>
<p>MongoDB shell version: 2.6.5</p>
<p>connecting to: 127.0.0.1:10001/test</p>
<p>blort:SECONDARY&gt;</p>
</blockquote>
<p>在 SECONDARY node 上，不能 save 数据，不能 show collections</p>
<blockquote>
<p>There is a special query option to tell a slave server that it is allowed to handle a query. (By default, queries will not be executed on a slave.) This option is called slaveOkay, and all MongoDB drivers provide a mechanism for setting it.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">blort:SECONDARY&gt; use testDB</span><br><span class="line">switched to db testDB</span><br><span class="line">blort:SECONDARY&gt; show collections</span><br><span class="line">2015-02-28T14:26:12.305+0800 error: &#123; &quot;$err&quot; : &quot;not master and slaveOk=false&quot;, &quot;code&quot; : 13435 &#125; at src/mongo/shell/query.js:131</span><br><span class="line">blort:SECONDARY&gt; db.users.save(&#123;name:&quot;fred&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;writeError&quot; : &#123; &quot;code&quot; : undefined, &quot;errmsg&quot; : &quot;not master&quot; &#125; &#125;)</span><br><span class="line">blort:SECONDARY&gt; show dbs</span><br><span class="line">admin   (empty)</span><br><span class="line">local   0.328GB</span><br><span class="line">testDB  0.078GB</span><br><span class="line">blort:SECONDARY&gt;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/02/28/mongo-Replica-Set-笔记/" data-id="cilxamgei0004lbrs5tnkjgki" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/replication/">replication</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Database-Commands-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/25/Database-Commands-笔记/" class="article-date">
  <time datetime="2015-02-25T03:21:39.000Z" itemprop="datePublished">2015-02-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/25/Database-Commands-笔记/">Database Commands 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>笔记：MongoDB - The Definitive Guide</p>
<p>One example of a database command that you are probably familiar with is drop: to drop a collection from the shell, we run db.test.drop(). Under the hood, this function is actually running the drop command—we can perform the exact same operation using runCommand:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.runCommand(&#123;&quot;drop&quot; : &quot;test&quot;&#125;);&#123;&quot;nIndexesWas&quot; : 1,&quot;msg&quot; : &quot;indexes dropped for collection&quot;, &quot;ns&quot; : &quot;test.test&quot;,&quot;ok&quot; : true&#125;</span><br></pre></td></tr></table></figure>
<p>The document we get as a result is the command response, which contains information about whether the command was successful, as well as any other information that the command might provide. The command response will always contain the key “ok”. If “ok” is true, the command was successful, and if it is false, the command failed for some reason.</p>
<p>If “ok” is false, then an additional key will be present, “errmsg”. The value of “errmsg” is a string explaining why the command failed. As an example, let’s try running the drop command again, on the collection that we just dropped:</p>
<pre><code>&gt; db.runCommand({&quot;drop&quot; : &quot;test&quot;});
{ &quot;errmsg&quot; : &quot;ns not found&quot;, &quot;ok&quot; : false }
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Commands in MongoDB are actually implemented as a special type of query that gets performed on the $cmd collection. runCommand just takes a command document and performs the equivalent query, so our drop call becomes the following:</span><br></pre></td></tr></table></figure>

db.$cmd.findOne({&quot;drop&quot; : &quot;test&quot;});
</code></pre><p>When the MongoDB server gets a query on the $cmd collection, it handles it using special logic, rather than the normal code for handling queries. Almost all MongoDB drivers provide a helper method like runCommand for running commands, but commands can always be run using a simple query if necessary.</p>
<p>Some commands require administrator access and must be run on the admin database. If such a command is run on any other database, it will return an “access denied” error.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/02/25/Database-Commands-笔记/" data-id="cilxamgdz0000lbrssi5hw071" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/command/">command</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-生成邀请码" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/12/生成邀请码/" class="article-date">
  <time datetime="2015-02-12T08:38:13.000Z" itemprop="datePublished">2015-02-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/12/生成邀请码/">生成邀请码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><ul>
<li>生成长度为 4 位的字符串邀请码</li>
<li>可以有数字和英文字母</li>
<li>英文字符不区分大小写</li>
<li>邀请码没有过期</li>
</ul>
<h3 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h3><h6 id="将数字转换成邀请码"><a href="#将数字转换成邀请码" class="headerlink" title="将数字转换成邀请码"></a>将数字转换成邀请码</h6><table>
<thead>
<tr>
<th>输入</th>
<th>输出</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0000</td>
</tr>
<tr>
<td>49360</td>
<td>1234</td>
</tr>
<tr>
<td>1679615</td>
<td>zzzz</td>
</tr>
</tbody>
</table>
<p>实现方法，将 10 进制转为 36 进制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function getInvitingCode(codeNumber) &#123;</span><br><span class="line">    var items = [</span><br><span class="line">        &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;,</span><br><span class="line">        &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;,</span><br><span class="line">        &quot;e&quot;, &quot;f&quot;, &quot;g&quot;,</span><br><span class="line">        &quot;h&quot;, &quot;i&quot;, &quot;g&quot;, &quot;k&quot;,</span><br><span class="line">        &quot;l&quot;, &quot;m&quot;, &quot;n&quot;,</span><br><span class="line">        &quot;o&quot;, &quot;p&quot;, &quot;q&quot;,</span><br><span class="line">        &quot;r&quot;, &quot;s&quot;, &quot;t&quot;,</span><br><span class="line">        &quot;u&quot;, &quot;v&quot;, &quot;w&quot;,</span><br><span class="line">        &quot;x&quot;, &quot;y&quot;, &quot;z&quot;</span><br><span class="line">    ]</span><br><span class="line">    var finalArray = []</span><br><span class="line">    var maxLength = 4</span><br><span class="line"></span><br><span class="line">    for (var i = 0; i &lt; maxLength; i++) &#123;</span><br><span class="line">        finalArray[i] = items[Math.floor(codeNumber / Math.pow(items.length, maxLength - i - 1))]</span><br><span class="line">        codeNumber = codeNumber % Math.pow(items.length, maxLength - i - 1)</span><br><span class="line">        console.log(finalArray)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return finalArray.join().replace(/,/ig, &quot;&quot;)</span><br><span class="line">&#125;</span><br><span class="line">console.log(getInvitingCode(0000) == &quot;0000&quot;)</span><br><span class="line">console.log(getInvitingCode(49360) == &quot;1234&quot;)</span><br><span class="line">console.log(getInvitingCode(1679615) == &quot;zzzz&quot;)</span><br></pre></td></tr></table></figure>
<p>打印结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ &apos;0&apos; ]</span><br><span class="line">[ &apos;0&apos;, &apos;0&apos; ]</span><br><span class="line">[ &apos;0&apos;, &apos;0&apos;, &apos;0&apos; ]</span><br><span class="line">[ &apos;0&apos;, &apos;0&apos;, &apos;0&apos;, &apos;0&apos; ]</span><br><span class="line">true</span><br><span class="line">[ &apos;1&apos; ]</span><br><span class="line">[ &apos;1&apos;, &apos;2&apos; ]</span><br><span class="line">[ &apos;1&apos;, &apos;2&apos;, &apos;3&apos; ]</span><br><span class="line">[ &apos;1&apos;, &apos;2&apos;, &apos;3&apos;, &apos;4&apos; ]</span><br><span class="line">true</span><br><span class="line">[ &apos;z&apos; ]</span><br><span class="line">[ &apos;z&apos;, &apos;z&apos; ]</span><br><span class="line">[ &apos;z&apos;, &apos;z&apos;, &apos;z&apos; ]</span><br><span class="line">[ &apos;z&apos;, &apos;z&apos;, &apos;z&apos;, &apos;z&apos; ]</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<h6 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h6><ol>
<li><p>根据数据库中已有的邀请码个数，生成下一个邀请码</p>
<p> 比如数据库中已经有 1000 个了，则下一个邀请码由 getInvitingCode(1001) 得到 07pt</p>
<p> 问题</p>
<ul>
<li>这样没有达到随机的效果，比如我得到了 0001 这样一个邀请码，则下一个就是 0002</li>
</ul>
</li>
<li><p>随机生成一个数字，然后根据这个数字得到邀请码，如果数据库中没有这个邀请码，则保存，如果有的话，换一个数字，循环操作，直到生成新的邀请码</p>
<p> 问题</p>
<ul>
<li>太慢，随着生成的邀请码增多，越来越慢</li>
<li>我随便猜一个邀请码 0001，按道理来说，肯定是有这样一个邀请码的，也没实现真正的随机</li>
</ul>
</li>
</ol>
<p>上面两种，我用了第一种，发现在客户端看到的邀请码太有规律了，所以不能用</p>
<p>要想实现随机，那就得减少邀请码的总数 36^{4} = 1679616</p>
<ol>
<li><p>最后一位为 0 至 9 的随机数</p>
<p> 去掉最后一位，邀请码总个数为 1679616 / 10 = 167961</p>
<p> 比如数据库中已有 1000 个邀请码，那么下一个就是 1001 + 一位随机数，即 10010(07q2) 到 10019(07qb)</p>
<p> 问题    </p>
<ul>
<li>1001 猜 10 次，也能猜到</li>
<li>有很多 0xxx 的数据（个人觉得不好）</li>
</ul>
</li>
<li><p>最后两位为 0 至 99 的随机数</p>
<p> 逻辑同上，邀请码总个数为 1679616 / 100 = 16796，要猜 100 次</p>
</li>
<li><p>前面两位取 0 至 15 的随机数</p>
<p> 1679616 去掉前两位，还剩 79616 位</p>
<p> 比如数据库中有 1000 个邀请码，下一个则为 (0至15) * 100000 + 1001</p>
</li>
<li><p>前面两位取 0 至 15 的随机数，并提前存到数据库</p>
<ul>
<li>邀请码，根据字符来排序，由于前面取的是随机数，那排序后，就得到了随机的顺序了</li>
<li>每次从数据库总去一个还没用的邀请码</li>
</ul>
</li>
</ol>
<h6 id="update"><a href="#update" class="headerlink" title="update"></a>update</h6><p>为了减小被猜出来的可能性，可将 items 顺序打乱</p>
<p>如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var items = [</span><br><span class="line">    &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;,</span><br><span class="line">    &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;,</span><br><span class="line">    &quot;e&quot;, &quot;f&quot;, &quot;g&quot;,</span><br><span class="line">    &quot;h&quot;, &quot;i&quot;, &quot;g&quot;, &quot;k&quot;,</span><br><span class="line">    &quot;l&quot;, &quot;m&quot;, &quot;n&quot;,</span><br><span class="line">    &quot;o&quot;, &quot;p&quot;, &quot;q&quot;,</span><br><span class="line">    &quot;r&quot;, &quot;s&quot;, &quot;t&quot;,</span><br><span class="line">    &quot;u&quot;, &quot;v&quot;, &quot;w&quot;,</span><br><span class="line">    &quot;x&quot;, &quot;y&quot;, &quot;z&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>可变为 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var items = [</span><br><span class="line">    &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;,</span><br><span class="line">    &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;,</span><br><span class="line">    &quot;h&quot;, &quot;i&quot;, &quot;g&quot;, &quot;k&quot;,</span><br><span class="line">    &quot;e&quot;, &quot;f&quot;, &quot;g&quot;,</span><br><span class="line">    &quot;l&quot;, &quot;m&quot;, &quot;n&quot;,</span><br><span class="line">    &quot;o&quot;, &quot;p&quot;, &quot;q&quot;,</span><br><span class="line">    &quot;u&quot;, &quot;v&quot;, &quot;w&quot;,</span><br><span class="line">    &quot;r&quot;, &quot;s&quot;, &quot;t&quot;,</span><br><span class="line">    &quot;x&quot;, &quot;y&quot;, &quot;z&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/02/12/生成邀请码/" data-id="cilxamgfo000llbrs3sqg8pht" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot/">boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/command/">command</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/event/">event</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goaccess/">goaccess</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iWatch/">iWatch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/">json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log/">log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logrotate/">logrotate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/master/">master</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memerory/">memerory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongo/">mongo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/">note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pm2/">pm2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pm2-web/">pm2-web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/replication/">replication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/">server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sharding/">sharding</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/slave/">slave</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/startup/">startup</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/boot/" style="font-size: 10px;">boot</a> <a href="/tags/command/" style="font-size: 10px;">command</a> <a href="/tags/event/" style="font-size: 10px;">event</a> <a href="/tags/goaccess/" style="font-size: 10px;">goaccess</a> <a href="/tags/iWatch/" style="font-size: 10px;">iWatch</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/log/" style="font-size: 16.67px;">log</a> <a href="/tags/logrotate/" style="font-size: 10px;">logrotate</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/master/" style="font-size: 10px;">master</a> <a href="/tags/memerory/" style="font-size: 10px;">memerory</a> <a href="/tags/mongo/" style="font-size: 20px;">mongo</a> <a href="/tags/mongodb/" style="font-size: 13.33px;">mongodb</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/node/" style="font-size: 13.33px;">node</a> <a href="/tags/nodejs/" style="font-size: 13.33px;">nodejs</a> <a href="/tags/note/" style="font-size: 10px;">note</a> <a href="/tags/pm2/" style="font-size: 10px;">pm2</a> <a href="/tags/pm2-web/" style="font-size: 10px;">pm2-web</a> <a href="/tags/replication/" style="font-size: 10px;">replication</a> <a href="/tags/server/" style="font-size: 16.67px;">server</a> <a href="/tags/sharding/" style="font-size: 10px;">sharding</a> <a href="/tags/slave/" style="font-size: 10px;">slave</a> <a href="/tags/startup/" style="font-size: 10px;">startup</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/03/18/node-内存优化笔记-一/">node 内存优化笔记(一)</a>
          </li>
        
          <li>
            <a href="/2016/03/14/linux-启动过程/">linux 启动过程</a>
          </li>
        
          <li>
            <a href="/2016/03/11/node-事件驱动机制/">node 事件驱动机制</a>
          </li>
        
          <li>
            <a href="/2015/03/18/iWatch-使用/">iWatch 使用</a>
          </li>
        
          <li>
            <a href="/2015/03/12/markdown-生成目录/">markdown 生成目录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Fred Jiang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3b7bc98f0d58e8d3df6d85dca6f10565";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  </div>
</body>
</html>