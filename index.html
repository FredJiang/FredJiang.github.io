<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title> </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content=" ">
<meta property="og:url" content="http://fredjiang.github.io/index.html">
<meta property="og:site_name" content=" ">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" ">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title=" " type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"> </a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle"> </a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fredjiang.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-node-代码优化笔记（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/21/node-代码优化笔记（一）/" class="article-date">
  <time datetime="2016-03-21T05:41:23.000Z" itemprop="datePublished">2016-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/21/node-代码优化笔记（一）/">node 代码优化笔记（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2016/03/21/node-代码优化笔记（一）/" data-id="cim2q4lbn000ik1rsomaby1lt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-node-内存优化笔记（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/18/node-内存优化笔记（一）/" class="article-date">
  <time datetime="2016-03-18T05:48:15.000Z" itemprop="datePublished">2016-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/18/node-内存优化笔记（一）/">node 内存优化笔记（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://www.amazon.cn/Deploying-Node-js-Pasquali-Sandro/dp/1783981407/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1458280419&amp;sr=1-1&amp;keywords=9781783981403">Deploying Node.js</a></p>
<p>The design and implementation of Node.js native modules follow a simple directive: keep everything asynchronous. This design ethic, by convention, informs the design of modules contributed by the Node community.</p>
        
          <p class="article-more-link">
            <a href="/2016/03/18/node-内存优化笔记（一）/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2016/03/18/node-内存优化笔记（一）/" data-id="cim2q4lbe000dk1rshm34ec1b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memerory/">memerory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-启动过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/14/linux-启动过程/" class="article-date">
  <time datetime="2016-03-14T10:36:49.000Z" itemprop="datePublished">2016-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/14/linux-启动过程/">linux 启动过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>从按下电源按钮到出现登陆提示，有以下流程</p>
<img src="/2016/03/14/linux-启动过程/linux-boot-process.png" alt="linux-boot-process.png" title="">
        
          <p class="article-more-link">
            <a href="/2016/03/14/linux-启动过程/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2016/03/14/linux-启动过程/" data-id="cim2q4lan0004k1rsrhe0jfrd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/boot/">boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/startup/">startup</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-node-事件驱动机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/11/node-事件驱动机制/" class="article-date">
  <time datetime="2016-03-11T14:58:12.000Z" itemprop="datePublished">2016-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/11/node-事件驱动机制/">node 事件驱动机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以下面代码执行为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);</span><br><span class="line">fs.readFile(&apos;foo.js&apos;, &#123;encoding:&apos;utf8&apos;&#125;, function(err,</span><br><span class="line">  fileContents) &#123;</span><br><span class="line">  console.log(&apos;Then the contents are available&apos;, fileContents);</span><br><span class="line">&#125;);</span><br><span class="line">console.log(&apos;This happens first&apos;);</span><br></pre></td></tr></table></figure>
        
          <p class="article-more-link">
            <a href="/2016/03/11/node-事件驱动机制/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2016/03/11/node-事件驱动机制/" data-id="cim2q4lb7000ak1rsz38avb5f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/event/">event</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-iWatch-使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/18/iWatch-使用/" class="article-date">
  <time datetime="2015-03-18T12:50:27.000Z" itemprop="datePublished">2015-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/18/iWatch-使用/">iWatch 使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装-iwatch"><a href="#安装-iwatch" class="headerlink" title="安装 iwatch"></a>安装 iwatch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install iwatch</span><br></pre></td></tr></table></figure>
<p>postfix 的配置选择</p>
<blockquote>
<p>Internet Site</p>
</blockquote>
<h3 id="配置-iwatch"><a href="#配置-iwatch" class="headerlink" title="配置 iwatch"></a>配置 iwatch</h3><p>配置文件为 /etc/iwatch/iwatch.xml</p>
        
          <p class="article-more-link">
            <a href="/2015/03/18/iWatch-使用/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/18/iWatch-使用/" data-id="cim2q4la80001k1rsn0qeh2mb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iWatch/">iWatch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log/">log</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-markdown-生成目录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/12/markdown-生成目录/" class="article-date">
  <time datetime="2015-03-12T13:37:39.000Z" itemprop="datePublished">2015-03-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/12/markdown-生成目录/">markdown 生成目录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>用 markdown 写完接口文档后，想根据接口文档自动生成一个目录</p>
        
          <p class="article-more-link">
            <a href="/2015/03/12/markdown-生成目录/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/12/markdown-生成目录/" data-id="cim2q4lap0006k1rsjxxk2dug" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/markdown/">markdown</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx-日志分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/10/nginx-日志分析/" class="article-date">
  <time datetime="2015-03-10T07:27:39.000Z" itemprop="datePublished">2015-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/10/nginx-日志分析/">nginx 日志分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装-goaccess"><a href="#安装-goaccess" class="headerlink" title="安装 goaccess"></a>安装 goaccess</h3><p>我的机器为 ubuntu，用 sudo apt-get install goaccess 安装后，使用时报错 Unknown option `–’.</p>
<p>命令</p>
<p>goaccess –version</p>
<p>依然报错 Unknown option `–’.</p>
<p>后参考官网编译安装成功 <a href="http://goaccess.io/download" target="_blank" rel="external">http://goaccess.io/download</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://tar.goaccess.io/goaccess-0.8.5.tar.gz</span><br><span class="line">$ tar -xzvf goaccess-0.8.5.tar.gz</span><br><span class="line">$ cd goaccess-0.8.5/</span><br><span class="line">$ sudo apt-get install libncursesw5-dev libglib2.0-dev libgeoip-dev</span><br><span class="line">$ ./configure --enable-geoip --enable-utf8</span><br><span class="line">$ make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>
<h3 id="修改-nginx-日志的归档文件名格式"><a href="#修改-nginx-日志的归档文件名格式" class="headerlink" title="修改 nginx 日志的归档文件名格式"></a>修改 nginx 日志的归档文件名格式</h3><p>配置文件为：/etc/logrotate.d/nginx</p>
<p>文件内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/var/log/nginx/*.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    missingok</span><br><span class="line">    rotate 52</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    notifempty</span><br><span class="line">    create 0644 www-data adm </span><br><span class="line">    dateext</span><br><span class="line">    dateformat -%Y%m%d</span><br><span class="line">    sharedscripts</span><br><span class="line">    prerotate</span><br><span class="line">        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \</span><br><span class="line">            run-parts /etc/logrotate.d/httpd-prerotate; \</span><br><span class="line">        fi; \</span><br><span class="line">    endscript</span><br><span class="line">    postrotate</span><br><span class="line">        [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加内容</p>
<blockquote>
<p>dateext</p>
<p>dateformat -%Y%m%d</p>
</blockquote>
<h3 id="修改-nginx-log-format"><a href="#修改-nginx-log-format" class="headerlink" title="修改 nginx log format"></a>修改 nginx log format</h3><p>配置文件为：/etc/nginx/nginx.conf</p>
<p>添加内容：</p>
<pre><code>    ##
    # Logging Settings
    ##
    log_format compression &apos;$remote_addr - $remote_user [$time_local] &apos;
                           &apos;&quot;$request&quot; $status $bytes_sent &apos;
                           &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$gzip_ratio &quot;$request_time&quot;&apos;;
    access_log /var/log/nginx/access.log compression;

#    access_log /var/log/nginx/access.log;
</code></pre><h3 id="重启-nginx"><a href="#重启-nginx" class="headerlink" title="重启 nginx"></a>重启 nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure>
<h3 id="python-脚本"><a href="#python-脚本" class="headerlink" title="python 脚本"></a>python 脚本</h3><p>新建文件 sendMail.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch sendMail.py</span><br><span class="line">chmod +x sendMail.py</span><br></pre></td></tr></table></figure>
<p>sendMail.py 文件内容</p>
<pre><code>#!/usr/bin/python
#coding:utf-8
import sys
import time
import datetime
import os
import subprocess
import smtplib
from email.mime.text import MIMEText

############################################################
# 配置
mailProxy = &quot;smtp.gmail.com&quot;
mailProxyPort = 587

mailAccountUsername = &apos;&apos;
mailAccountUserPassword = &apos;&apos;

mailSubject = &quot;&quot;
mailFrom = &apos;&apos;
mailTo = &apos;mail1;mail2&apos;
############################################################


def generateReport():
    print(&quot;generateReport&quot;)
    print(datetime.datetime.now())

    global hasSend

    delta = datetime.timedelta(1)
    yesterday = datetime.date.today() - delta
    accessLogFileGZ = r&apos;/var/log/nginx/access.log-&apos; + yesterday.strftime(&apos;%Y%m%d&apos;) + &apos;.gz&apos;
    reportSaveFileHtml = r&apos;&apos; + os.getcwd() + &quot;/&quot; + yesterday.strftime(&apos;%Y%m%d&apos;) + &apos;.html&apos;

    print(&quot;accessLogFileGZ &quot; + accessLogFileGZ)
    print(&quot;reportSaveFileHtml &quot; + reportSaveFileHtml)

    if os.path.isfile(accessLogFileGZ) and (not os.path.isfile(reportSaveFileHtml)):
        cmd = r&apos;zcat -f &apos; + accessLogFileGZ + r&apos; | goaccess --date-format=&quot;%d/%b/%Y&quot; --log-format=&quot;%h - %^ [%d:%^] \&quot;%r\&quot; %s %b \&quot;%R\&quot; \&quot;%u\&quot; \&quot;%^ \&quot;%T\&quot;&quot; &gt; &apos; + reportSaveFileHtml
        print(&quot;cmd &quot; + cmd)
        subprocess.call(cmd, shell=True)
        hasSend = False
    else:
        print(&quot;os.path.isfile(accessLogFileGZ) and (not os.path.isfile(reportSaveFileHtml) false&quot;)
        hasSend = True

def sendMail():
    print(&quot;sendMail&quot;)
    print(datetime.datetime.now())

    global hasSend

    delta = datetime.timedelta(1)
    yesterday = datetime.date.today() - delta
    reportSaveFileHtml = r&apos;&apos; + os.getcwd() + &quot;/&quot; + yesterday.strftime(&apos;%Y%m%d&apos;) + &apos;.html&apos;

    print(&quot;reportSaveFileHtml &quot; + reportSaveFileHtml)

    if os.path.isfile(reportSaveFileHtml):
        f = open(reportSaveFileHtml)
        content = f.read()
        f.close()

        msg = MIMEText(content, &apos;html&apos;, &apos;utf-8&apos;)
        msg[&apos;Subject&apos;] = mailSubject + &quot;(&quot; + yesterday.strftime(&apos;%Y%m%d&apos;) + &quot;)&quot;
        msg[&apos;From&apos;] =  mailFrom
        msg[&apos;To&apos;] = mailTo

        try:
            s = smtplib.SMTP()
            s.connect(mailProxy, mailProxyPort)
            s.ehlo()
            s.starttls()
            s.login(mailAccountUsername, mailAccountUserPassword)
            s.sendmail(mailFrom, mailTo.split(&apos;;&apos;), msg.as_string())
            s.close()
            hasSend = True
        except Exception, e:
            hasSend = False
            print str(e)

hasSend = False
interval = 10 * 60

while True:
    generateReport()

    if not hasSend:
        print(&quot;&quot;)
        sendMail()

    print(&quot;&quot;)
    print(&quot;hasSend&quot;, hasSend)
    sys.stdout.flush()
    time.sleep(interval)
</code></pre><h3 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h3><p>python定时生成报告及发邮件，使用 nohup 放入后台运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python sendmail.py &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python sendmail.py &amp;</span><br></pre></td></tr></table></figure>
<h3 id="获取机器名字"><a href="#获取机器名字" class="headerlink" title="获取机器名字"></a>获取机器名字</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import platform</span><br><span class="line">hostname = platform.node()</span><br><span class="line">print(hostname)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/10/nginx-日志分析/" data-id="cim2q4lbk000gk1rsf0oxzwzn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/goaccess/">goaccess</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log/">log</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mongodb-sharding-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/04/mongodb-sharding-笔记/" class="article-date">
  <time datetime="2015-03-04T09:57:35.000Z" itemprop="datePublished">2015-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/04/mongodb-sharding-笔记/">mongodb sharding 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>笔记：MongoDB - The Definitive Guide</p>
<p><a href="http://docs.mongodb.org/manual/sharding" target="_blank" rel="external">http://docs.mongodb.org/manual/sharding</a></p>
<h3 id="When-to-Shard"><a href="#When-to-Shard" class="headerlink" title="When to Shard"></a>When to Shard</h3><ul>
<li>You’ve run out of disk space on your current machine.</li>
<li>You want to write data faster than a single mongod can handle.</li>
<li>Youwanttokeepalargerproportionofdatainmemorytoimproveperformance.</li>
</ul>
<h3 id="The-Key-to-Sharding-Shard-Keys"><a href="#The-Key-to-Sharding-Shard-Keys" class="headerlink" title="The Key to Sharding: Shard Keys"></a>The Key to Sharding: Shard Keys</h3><p>When you set up sharding, you choose a key from a collection and use that key’s values to split up the data. This key is called a shard key.</p>
<p>Let’s look at an example to see how this works: suppose we had a collection of documents representing people. If we chose “name” as our shard key, one shard could hold documents where the “name” started with A–F, the next shard could hold names from G–P, and the final shard would hold names from Q–Z. As you added (or removed) shards, MongoDB would rebalance this data so that each shard was getting a balanced amount of traffic and a sensible amount of data (e.g., if a shard is getting a lot of traffic, it might have less data than a shard with data that is less “hot”).</p>
<p>If we choose to shard on something like “timestamp”, where the value is probably going to increase and not jump around a lot, we’ll be sending all of the inserts to one shard (the one with the [June 27, 2003, ∞] chunk). Notice that, if we add a new shard and it splits the data again, we’ll still be inserting on just one server. If we add a new shard, MongoDB might split [June 27, 2003, ∞] into [June 27, 2003, December 12, 2010) and [December 12, 2010, ∞]. We’ll always have a chunk that will be “some date through infinity,” which is where our inserts will be going. This isn’t good for a very high write load, but it will make queries on the shard key very efficient.</p>
<h3 id="Setting-Up-Sharding"><a href="#Setting-Up-Sharding" class="headerlink" title="Setting Up Sharding"></a>Setting Up Sharding</h3><p>Sharding basically involves three different components working together:</p>
<h6 id="shard"><a href="#shard" class="headerlink" title="shard"></a>shard</h6><p>A shard is a container that holds a subset of a collection’s data. A shard is either a single mongod server (for development/testing) or a replica set (for production). Thus, even if there are many servers in a shard, there is only one master, and all of the servers contain the same data.</p>
<h6 id="mongos"><a href="#mongos" class="headerlink" title="mongos"></a>mongos</h6><p>This is the router process and comes with all MongoDB distributions. It basically just routes requests and aggregates responses. It doesn’t store any data or configuration information. (Although it does cache information from the config servers.)</p>
<p>######config server<br>Config servers store the configuration of the cluster: which data is on which shard. Because mongos doesn’t store anything permanently, it needs somewhere to get the shard configuration. It syncs this data from the config servers.</p>
<p>If you are working with MongoDB already, you probably have a shard ready to go. (Your current mongod can become your first shard.) The following section shows how to create a new shard from scratch, but feel free to use your existing database instead.</p>
<h3 id="Starting-the-Servers"><a href="#Starting-the-Servers" class="headerlink" title="Starting the Servers"></a>Starting the Servers</h3><p>First we need to start up our config server and mongos. The config server needs to be started first, because mongos uses it to get its configuration. The config server can be started like any other mongod process:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/dbs/config</span><br><span class="line">mongod --dbpath ~/dbs/config --port 20000</span><br></pre></td></tr></table></figure>
<p>Now you need a mongos process for your application to connect to. Routing servers don’t even need a data directory, but they need to know where the config server is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos --port 30000 --configdb localhost:20000</span><br></pre></td></tr></table></figure>
<h6 id="Adding-a-shard"><a href="#Adding-a-shard" class="headerlink" title="Adding a shard"></a>Adding a shard</h6><p>A shard is just a normal mongod instance (or replica set):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/dbs/shard1</span><br><span class="line">mongod --dbpath ~/dbs/shard1 --port 10000</span><br></pre></td></tr></table></figure>
<p>Now we’ll connect to the mongos process we started and add the shard to the cluster.<br>Start up a shell connected to your mongos:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo localhost:30000/admin</span><br></pre></td></tr></table></figure>
<p>Make sure you’re connected to mongos, not a mongod. Now you can add this shard with<br>the addshard database command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;addshard : &quot;localhost:10000&quot;, allowLocal : true&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Sharding-Data"><a href="#Sharding-Data" class="headerlink" title="Sharding Data"></a>Sharding Data</h3><p>Let’s look at an example: we’ll shard the bar collection in the foo database on the “_id” key. First, we enable sharding for foo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;&quot;enablesharding&quot; : &quot;foo&quot;&#125;)</span><br><span class="line">db.runCommand(&#123;&quot;shardcollection&quot; : &quot;foo.bar&quot;, &quot;key&quot; : &#123;&quot;_id&quot; : 1&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Production-Configuration"><a href="#Production-Configuration" class="headerlink" title="Production Configuration"></a>Production Configuration</h3><p>The example in the previous section is fine for trying sharding or for development. However, when you move an application into production, you’ll want a more robust setup. To set up sharding with no points of failure, you’ll need the following:</p>
<ul>
<li>Multiple config servers • Multiplemongosservers</li>
<li>Replica sets for each shard</li>
<li>w set correctly (see the previous chapter for information on w and replication)</li>
</ul>
<h6 id="A-Robust-Config"><a href="#A-Robust-Config" class="headerlink" title="A Robust Config"></a>A Robust Config</h6><p>Setting up multiple config servers is simple. As of this writing, you can have one config server (for development) or three config servers (for production).</p>
<p>Setting up multiple config servers is the same as setting up one; you just do it three times:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/dbs/config1 ~/dbs/config2 ~/dbs/config3mongod --dbpath ~/dbs/config1 --port 20001mongod --dbpath ~/dbs/config2 --port 20002mongod --dbpath ~/dbs/config3 --port 20003</span><br></pre></td></tr></table></figure>
<p>Then, when you start a mongos, you should connect it to all three config servers:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos --configdb localhost:20001,localhost:20002,localhost:20003</span><br></pre></td></tr></table></figure>
<p>Config servers use two-phase commit, not the normal MongoDB asynchronous repli- cation, to maintain separate copies of the cluster’s configuration. This ensures that they always have a consistent view of the cluster’s state. It also means that if a single config server is down, the cluster’s configuration information will go read-only. Clients are still able to do both reads and writes, but no rebalancing will happen until all of the config servers are back up.</p>
<h6 id="Many-mongos"><a href="#Many-mongos" class="headerlink" title="Many mongos"></a>Many mongos</h6><p>You can also run as many mongos processes as you want. One recommended setup is to run a mongos process for every application server. That way, each application server can talk to mongos locally, and if the server goes down, no one will be trying to talk to a mongos that isn’t there.</p>
<h6 id="A-Sturdy-Shard"><a href="#A-Sturdy-Shard" class="headerlink" title="A Sturdy Shard"></a>A Sturdy Shard</h6><p>In production, each shard should be a replica set. That way, an individual server can fail without bringing down the whole shard. To add a replica set as a shard, pass its name and a seed to the addshard command.<br>For example, say we have a replica set named “foo” containing a server at prod.example.com:27017 (among other servers). We could add this set to the cluster with the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;&quot;addshard&quot; : &quot;foo/prod.example.com:27017&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>If prod.example.com goes down, mongos will know that it is connected to a replica set<br>and use the new primary for that set.</p>
<h6 id="Physical-Servers"><a href="#Physical-Servers" class="headerlink" title="Physical Servers"></a>Physical Servers</h6><p>This may seem like an overwhelming number of machines: three config servers, at least two mongods per shard, and as many mongos processes as you want. However, not ev- erything has to have its own machine. The main thing to avoid is putting an entire component on one machine. For example, avoid putting all three config servers, all of your mongos processes, or an entire replica set on one machine. However, a config server and mongos processes can happily share a box with a member of a replica set.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/03/04/mongodb-sharding-笔记/" data-id="cim2q4lav0007k1rsfic7n4lh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sharding/">sharding</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mongo-Replica-Set-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/28/mongo-Replica-Set-笔记/" class="article-date">
  <time datetime="2015-02-28T06:53:10.000Z" itemprop="datePublished">2015-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/28/mongo-Replica-Set-笔记/">mongo Replica Set 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>笔记：MongoDB - The Definitive Guide</p>
<h6 id="Replica-Sets"><a href="#Replica-Sets" class="headerlink" title="Replica Sets"></a>Replica Sets</h6><blockquote>
<p>A replica set is basically a master-slave cluster with automatic failover. The biggest difference between a master-slave cluster and a replica set is that a replica set does not have a single master: one is elected by the cluster and may change to another node if the current master goes down. However, they look very similar: a replica set always has a single master node (called a primary) and one or more slaves (called secondaries). </p>
</blockquote>
        
          <p class="article-more-link">
            <a href="/2015/02/28/mongo-Replica-Set-笔记/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/02/28/mongo-Replica-Set-笔记/" data-id="cim2q4lai0003k1rsdmmxrvfh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/replication/">replication</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Database-Commands-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/25/Database-Commands-笔记/" class="article-date">
  <time datetime="2015-02-25T03:21:39.000Z" itemprop="datePublished">2015-02-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/25/Database-Commands-笔记/">Database Commands 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>笔记：MongoDB - The Definitive Guide</p>
<p>One example of a database command that you are probably familiar with is drop: to drop a collection from the shell, we run db.test.drop(). Under the hood, this function is actually running the drop command—we can perform the exact same operation using runCommand:</p>
        
          <p class="article-more-link">
            <a href="/2015/02/25/Database-Commands-笔记/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fredjiang.github.io/2015/02/25/Database-Commands-笔记/" data-id="cim2q4la00000k1rs446josdh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/command/">command</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot/">boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/command/">command</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/event/">event</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goaccess/">goaccess</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iWatch/">iWatch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/">json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log/">log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logrotate/">logrotate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/master/">master</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memerory/">memerory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongo/">mongo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/note/">note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pm2/">pm2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pm2-web/">pm2-web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/replication/">replication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/">server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sharding/">sharding</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/slave/">slave</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/startup/">startup</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/boot/" style="font-size: 10px;">boot</a> <a href="/tags/command/" style="font-size: 10px;">command</a> <a href="/tags/event/" style="font-size: 10px;">event</a> <a href="/tags/goaccess/" style="font-size: 10px;">goaccess</a> <a href="/tags/iWatch/" style="font-size: 10px;">iWatch</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/log/" style="font-size: 16.67px;">log</a> <a href="/tags/logrotate/" style="font-size: 10px;">logrotate</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/master/" style="font-size: 10px;">master</a> <a href="/tags/memerory/" style="font-size: 10px;">memerory</a> <a href="/tags/mongo/" style="font-size: 20px;">mongo</a> <a href="/tags/mongodb/" style="font-size: 13.33px;">mongodb</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/node/" style="font-size: 13.33px;">node</a> <a href="/tags/nodejs/" style="font-size: 13.33px;">nodejs</a> <a href="/tags/note/" style="font-size: 10px;">note</a> <a href="/tags/pm2/" style="font-size: 10px;">pm2</a> <a href="/tags/pm2-web/" style="font-size: 10px;">pm2-web</a> <a href="/tags/replication/" style="font-size: 10px;">replication</a> <a href="/tags/server/" style="font-size: 16.67px;">server</a> <a href="/tags/sharding/" style="font-size: 10px;">sharding</a> <a href="/tags/slave/" style="font-size: 10px;">slave</a> <a href="/tags/startup/" style="font-size: 10px;">startup</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/03/21/node-代码优化笔记（一）/">node 代码优化笔记（一）</a>
          </li>
        
          <li>
            <a href="/2016/03/18/node-内存优化笔记（一）/">node 内存优化笔记（一）</a>
          </li>
        
          <li>
            <a href="/2016/03/14/linux-启动过程/">linux 启动过程</a>
          </li>
        
          <li>
            <a href="/2016/03/11/node-事件驱动机制/">node 事件驱动机制</a>
          </li>
        
          <li>
            <a href="/2015/03/18/iWatch-使用/">iWatch 使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Fred Jiang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3b7bc98f0d58e8d3df6d85dca6f10565";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </div>
</body>
</html>